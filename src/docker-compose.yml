version: '2.4'

networks:
  internal:
    name : wise-cube-internal
    # Use a custom driver
    driver: bridge
    internal: true
  external:
    name : wise-cube-external
    # Use a custom driver which takes special options
    driver: bridge
    enable_ipv6: true
    driver_opts:
      com.docker.network.enable_ipv6: "true"
    ipam:
      driver: default
      config:
        - subnet: 172.16.238.0/24
          gateway: 172.16.238.1
        - subnet: fd11:0011:0011:1100::/64
          gateway: fd11:11:11:1100:0:0:0:1
  

services:
  mqttsn-gateway:
    container_name: mqttsn-gateway
    build: mqttsn-gateway
    networks:
      - internal
      - external
    ports:
      - 1886:1886/udp
    expose:
      - 1886/udp
    depends_on:
      - mqtt-broker
    volumes:
      - ./mqttsn-gateway/conf:/paho/config/
  
  mqtt-broker:
    container_name: mqtt-broker
    build: mqtt-broker
    networks:
      - internal
      - external
    ports:
      - 1884:1884
      - 1885:1885
    expose:
      - 1884
    volumes:
      - ./mqtt-broker/conf:/mosquitto/config/

  mqtt-cubes-handler:
    container_name: mqtt-cubes-handler
    build: py-mqtt-sample
    environment:
      IS_DOCKER: 1
      SQLALCHEMY_DATABASE_URI: postgresql+psycopg2://test:test@db/wise-cube
    networks:
      - internal
    volumes:
      - ./py-mqtt-sample:/src/
      - ./common:/src/common
    depends_on:
      - mqtt-broker
      - db

  http-server:
    build: py-http-server
    container_name: http-server

    environment:
      IS_DOCKER: 1
      STAGE: test
      SQLALCHEMY_DATABASE_URI: postgresql+psycopg2://test:test@db/wise-cube
    networks:
      - internal
      - external
    ports:
      - 5000:5000
    depends_on:
      - db
      - mqtt-cubes-handler
    volumes:
      - ./py-http-server:/src/
      - ./common:/src/common
    restart: always

  db:
    container_name: db
    image: postgres:latest
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: wise-cube
    networks:
      - internal
    ports:
      - 5432:5432
    expose:
      - 5342
    volumes:
      - /tmp/postgres-data:/var/lib/postgresql/data
    restart: always
